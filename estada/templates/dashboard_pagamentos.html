{% extends 'base.html' %}


{% block content %}
<section class="section">
    <div class="container">
        {% if pagamentos %}
        <div class="card-body">
            <h3 class="text-center">Pagamentos Registrados</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-success">
                        <tr>
                            <th>Data</th>
                            <th>Valor</th>
                            <th>Veículo</th>
                            <th>Vaga</th>
                            <th>Funcionário</th>
                            <th>Modalidade</th>
                            <th>Tempo total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in pagamentos %}
                        <tr>
                            <td>{{ p.data_pagamento|date:"d/m/Y H:i" }}</td>
                            <td>R$ {{ p.valor_pago }}</td>
                            <td>{{ p.veiculo }}</td>
                            <td>{{ p.vaga }}</td>
                            <td>{{ p.funcionario }}</td>
                            <td>{{ p.modalidade_pagamento }}</td>
                            <td>
                                {% if p.tempo_total %}
                                    {{ p.tempo_total }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <div class="col-12 mt-5">
            <canvas id="GraficoPagamentos" width="800" height="400"></canvas>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                const pagamentos_data = [
                    {% for p in pagamentos %}
                    {
                        'data_pagamento': '{{ p.data_pagamento|date:"d/m/Y" }}',
                        'valor_pago': {{ p.valor_pago|default_if_none:"0"|floatformat }},
                        'veiculo': '{{ p.veiculo }}',
                        'vaga': '{{ p.vaga }}',
                        'funcionario': '{{ p.funcionario }}',
                        'modalidade_pagamento': '{{ p.modalidade_pagamento }}',
                        'tempo_total': '{% if p.tempo_total %}{{ p.tempo_total }}{% else %}-{% endif %}'
                    }{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                ];

                const ctx = document.getElementById('GraficoPagamentos').getContext('2d');
                const myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: pagamentos_data.map(p => p.data_pagamento),
                        datasets: [{
                            label: "Curva dos valores recebidos",
                            data: pagamentos_data.map(p => p.valor_pago),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: false,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const p = pagamentos_data[context.dataIndex];
                                        return [
                                            `Valor: R$ ${p.valor_pago}`,
                                            `Veículo: ${p.veiculo}`,
                                            `Vaga: ${p.vaga}`,
                                            `Funcionário: ${p.funcionario}`,
                                            `Modalidade: ${p.modalidade_pagamento}`,
                                            `Tempo total: ${p.tempo_total}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            </script>
        </div>
    </div>
</section>
{% endblock %}
